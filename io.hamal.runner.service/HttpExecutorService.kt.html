<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpExecutorService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mono</a> &gt; <a href="index.source.html" class="el_package">io.hamal.runner.service</a> &gt; <span class="el_source">HttpExecutorService.kt</span></div><h1>HttpExecutorService.kt</h1><pre class="source lang-java linenums">package io.hamal.runner.service

import io.hamal.lib.sdk.DefaultHamalSdk
import io.hamal.lib.sdk.HttpTemplateSupplier
import io.hamal.runner.config.SandboxFactory
import io.hamal.runner.connector.HttpConnector
import io.hamal.runner.connector.UnitOfWork
import io.hamal.runner.run.DefaultCodeRunner
import org.slf4j.LoggerFactory
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.scheduling.concurrent.ThreadPoolTaskScheduler
import org.springframework.stereotype.Service
import java.util.concurrent.TimeUnit
import kotlin.time.Duration.Companion.milliseconds
import kotlin.time.toJavaDuration

<span class="fc" id="L17">@Service</span>
<span class="fc" id="L18">class HttpExecutorService(</span>
<span class="fc" id="L19">    private val httpTemplateSupplier: HttpTemplateSupplier,</span>
<span class="fc" id="L20">    private val runnerExecutor: ThreadPoolTaskScheduler,</span>
<span class="fc" id="L21">    private val sandboxFactory: SandboxFactory</span>
) {
    @Scheduled(initialDelay = 1, timeUnit = TimeUnit.SECONDS, fixedRate = Int.MAX_VALUE.toLong())
    fun run() {
<span class="fc" id="L25">        val template = httpTemplateSupplier()</span>
<span class="fc" id="L26">        val sdk = DefaultHamalSdk(template)</span>
<span class="fc" id="L27">        val connector = HttpConnector(sdk)</span>
<span class="fc" id="L28">        val execute = DefaultCodeRunner(connector, sandboxFactory)</span>
<span class="fc" id="L29">        runnerExecutor.scheduleAtFixedRate({</span>
<span class="fc" id="L30">            connector.poll().forEach { uow -&gt;</span>

<span class="fc" id="L32">                execute(</span>
<span class="fc" id="L33">                    UnitOfWork(</span>
<span class="fc" id="L34">                        id = uow.id,</span>
<span class="fc" id="L35">                        inputs = uow.inputs,</span>
<span class="fc" id="L36">                        state = uow.state,</span>
<span class="fc" id="L37">                        code = uow.code,</span>
<span class="fc" id="L38">                        invocation = uow.invocation,</span>
<span class="fc" id="L39">                        correlation = uow.correlation</span>
                    )
                )

//                    try {
//                        log.debug(&quot;Picked up: {}&quot;, unitOfWork.id)
//
////                        lateinit var stateResult: State
//                        val eventsCollector = mutableListOf&lt;Event&gt;()
//
//                        sandboxFactory.create(DefaultSandboxContext())
//                            .use { sb -&gt;
//                                val ctxExtension = CtxExtensionFactory(eventsCollector).create()
//
//                                val internalTable = sb.state.tableCreateMap(ctxExtension.internals.size)
//                                ctxExtension.internals.forEach { entry -&gt;
//                                    val fn = entry.value
//                                    require(fn is FunctionType&lt;*, *, *, *&gt;)
//                                    internalTable[entry.key] = fn
//                                }
//
//                                sb.setGlobal(&quot;_internal&quot;, internalTable)
//                                sb.state.load(ctxExtension.init)
//                                sb.state.load(&quot;${ctxExtension.name} = create_extension_factory()()&quot;)
//                                sb.unsetGlobal(&quot;_internal&quot;)
//
////                            sb.run { state -&gt;
////                                val ctx = state.tableCreateMap(1)
//
////                                sb.native.pushFunction(EmitFunction(eventsCollector))
////                                sb.native.tabletSetField(ctx.index, &quot;emit&quot;)
//
////                                val funcState = state.tableCreateMap(1)
////                                exec.state.value.forEach { entry -&gt;
////                                    when (val value = entry.value) {
////                                        is BooleanType -&gt; funcState[entry.key] = value
////                                        is NumberType -&gt; funcState[entry.key] = value
////                                        is StringType -&gt; funcState[entry.key] = value
////                                        else -&gt; TODO()
////                                    }
////                                }
////                                ctx[&quot;state&quot;] = funcState
////                                log.debug(&quot;Injected state into context&quot;)
////
////
////                                val invocation = exec.invocation
////                                val events = state.tableCreateArray(0)
////                                if (invocation is EventInvocation) {
////                                    invocation.events.forEach { evt -&gt;
////                                        val evtTable = state.tableCreateMap(1)
////                                        evt.value.forEach { payload -&gt;
////                                            when (val v = payload.value) {
////                                                is StringType -&gt; evtTable[payload.key] = v
////                                                is NumberType -&gt; evtTable[payload.key] = v
////                                                else -&gt; TODO()
////                                            }
////                                        }
////                                        sb.native.tableAppend(events.index)
////                                    }
////                                }
////
////                                ctx[&quot;events&quot;] = events
////                                log.debug(&quot;Injected {} events into context&quot;, events.length())
////                                state.setGlobal(&quot;ctx&quot;, ctx)
////                            }
//
//                                log.debug(&quot;Start code execution&quot;)
//                                sb.load(unitOfWork.code)
//                                log.debug(&quot;Code execution finished normally&quot;)
//
//
////                            sb.run { state -&gt;
////                                val ctx = state.getGlobalTableMap(&quot;ctx&quot;)
////                                val funcState = ctx.getTableMap(&quot;state&quot;)
////
////                                val stateMap = mutableMapOf&lt;StringType, SerializableType&gt;()
////
////                                state.native.pushNil()
////                                while (state.native.tableNext(funcState.index)) {
////                                    val k = state.getStringValue(-2)
////                                    val v = state.getAny(-1)
////
////                                    when (val n = v.value) {
////                                        is NumberType -&gt; stateMap[k] = n
////                                        is StringType -&gt; stateMap[k] = n
////                                        else -&gt; TODO()
////                                    }
////
////                                    state.native.pop(1)
////                                }
////
////                                stateResult = State(TableType(stateMap))
////                            }
//                            }
//
//                        sdk.execService().complete(unitOfWork.id, State(), eventsCollector)
//                        log.debug(&quot;Completed exec: {}&quot;, unitOfWork.id)
//
//                    } catch (kua: ExtensionError) {
//                        kua.printStackTrace()
//
//                        val e = kua.cause
//                        if (e is ExitError) {
//                            if (e.status == NumberType(0.0)) {
//                                sdk.execService().complete(unitOfWork.id, State(), listOf())
//                                log.debug(&quot;Completed exec: {}&quot;, unitOfWork.id)
//                            } else {
//                                sdk.execService().fail(unitOfWork.id, ErrorType(e.message ?: &quot;Unknown reason&quot;))
//                                log.debug(&quot;Failed exec: {}&quot;, unitOfWork.id)
//                            }
//                        } else {
//                            sdk.execService().fail(unitOfWork.id, ErrorType(kua.message ?: &quot;Unknown reason&quot;))
//                            log.debug(&quot;Failed exec: {}&quot;, unitOfWork.id)
//                        }
//                    } catch (a: AssertionError) {
//                        a.printStackTrace()
//                        sdk.execService().fail(unitOfWork.id, ErrorType(a.message ?: &quot;Unknown reason&quot;))
//                        log.debug(&quot;Assertion error: {} - {}&quot;, unitOfWork.id, a.message)
//                    } catch (t: Throwable) {
//                        t.printStackTrace()
//                        sdk.execService().fail(unitOfWork.id, ErrorType(t.message ?: &quot;Unknown reason&quot;))
//                        log.debug(&quot;Failed exec: {}&quot;, unitOfWork.id)
//                    }
//                }
<span class="fc" id="L163">            }</span>
<span class="fc" id="L164">        }, 1.milliseconds.toJavaDuration())</span>
<span class="fc" id="L165">    }</span>

    companion object {
<span class="fc" id="L168">        private val log = LoggerFactory.getLogger(HttpExecutorService::class.java)</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>