<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgentService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bootstrap</a> &gt; <a href="index.source.html" class="el_package">io.hamal.agent.service</a> &gt; <span class="el_source">AgentService.kt</span></div><h1>AgentService.kt</h1><pre class="source lang-java linenums">package io.hamal.agent.service

import io.hamal.agent.adapter.ExtensionLoader
import io.hamal.agent.extension.api.ExtensionFuncInvocationContext
import io.hamal.lib.script.api.value.EnvValue
import io.hamal.lib.script.api.value.FuncInvocationContextFactory
import io.hamal.lib.script.api.value.IdentValue
import io.hamal.lib.script.api.value.Value
import io.hamal.lib.script.impl.DefaultSandbox
import io.hamal.lib.script.impl.builtin.AssertFunction
import io.hamal.lib.script.impl.builtin.RequireFunction
import io.hamal.lib.sdk.DefaultHamalSdk
import io.hamal.lib.sdk.service.ExecService
import jakarta.annotation.PostConstruct
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.stereotype.Service
import java.io.File
import java.util.concurrent.CompletableFuture
import java.util.concurrent.TimeUnit

<span class="nc" id="L21">@Service</span>
<span class="nc" id="L22">class AgentService {</span>

//    private val functionValues = mutableListOf&lt;FuncValue&gt;()

    //FIXME introduce WorkerExtensionEnvironment as a wrapper around native env
<span class="nc" id="L27">    private val extensionEnvironments = mutableListOf&lt;EnvValue&gt;()</span>

    @PostConstruct
    fun postConstruct() {

<span class="nc" id="L32">        println(&quot;Agent active&quot;)</span>

<span class="nc" id="L34">        val entryPointLoader = ExtensionLoader.DefaultImpl()</span>

//        val s =
//            entryPointLoader.load(
//                File(&quot;/home/ddymke/Repo/hamal/worker/extension/impl/web3/build/libs/extension-starter.jar&quot;)
//            )
//        nativeFunctions.addAll(s.functionFactories())

//        val x =
//            entryPointLoader.load(
//                File(&quot;/home/ddymke/Repo/hamal/agent/extension/impl/web3/build/libs/extension-web3.jar&quot;)
//            )
//
//
//        extensionEnvironments.add(x.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times

<span class="nc" id="L50">        val log =</span>
<span class="nc" id="L51">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/log/build/libs/extension-std-log.jar&quot;))</span>
<span class="nc" id="L52">        extensionEnvironments.add(log.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

<span class="nc" id="L54">        val sys =</span>
<span class="nc" id="L55">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/sys/build/libs/extension-std-sys.jar&quot;))</span>
<span class="nc" id="L56">        extensionEnvironments.add(sys.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

<span class="nc" id="L58">        val debug =</span>
<span class="nc" id="L59">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/debug/build/libs/extension-std-debug.jar&quot;))</span>
<span class="nc" id="L60">        extensionEnvironments.add(debug.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

//        x.functionFactories()

//            .map { it.create() }
//            .forEach { it(DefaultContext()) }


<span class="nc" id="L68">    }</span>

    @Scheduled(initialDelay = 100, fixedDelay = 1000, timeUnit = TimeUnit.MILLISECONDS)
    fun run() {
<span class="nc" id="L72">        CompletableFuture.runAsync {</span>
<span class="nc" id="L73">            DefaultHamalSdk(&quot;http://localhost:8084&quot;).execService()</span>
<span class="nc" id="L74">                .poll()</span>
<span class="nc" id="L75">                .requests.forEach { request -&gt;</span>

<span class="nc" id="L77">                    try {</span>

<span class="nc" id="L79">                        println(&quot;${request.inputs} - ${request.inputs.value}&quot;)</span>
<span class="nc" id="L80">                        println(&quot;${request.secrets} - ${request.secrets.value.size}&quot;)</span>

//                println(&quot;$request&quot;)
//                println(&quot;Execute: ${request.id} - ${request.correlation}&quot;)
//                println(&quot;State: ${request.statePayload}&quot;)
//
<span class="nc bnc" id="L86" title="All 4 branches missed.">                        val counter = (request.statePayload?.bytes?.let { String(it) } ?: &quot;0&quot;).toInt()</span>
//                println(counter)

<span class="nc" id="L89">                        val env = EnvValue(</span>
<span class="nc" id="L90">                            ident = IdentValue(&quot;_G&quot;),</span>
<span class="nc" id="L91">                            values = mapOf(</span>
<span class="nc" id="L92">                                IdentValue(&quot;assert&quot;) to AssertFunction,</span>
<span class="nc" id="L93">                                IdentValue(&quot;require&quot;) to RequireFunction</span>
                            )
                        )


<span class="nc" id="L98">                        extensionEnvironments.forEach { environment -&gt;</span>
<span class="nc" id="L99">                            env.addGlobal(environment.ident, environment)</span>
<span class="nc" id="L100">                        }</span>


<span class="nc" id="L103">                        val sandbox = DefaultSandbox(</span>
<span class="nc" id="L104">                            env,</span>
<span class="nc" id="L105">                            object : FuncInvocationContextFactory&lt;ExtensionFuncInvocationContext&gt; {</span>
                                override fun create(
                                    parameters: List&lt;Value&gt;,
                                    env: EnvValue
                                ): ExtensionFuncInvocationContext {
<span class="nc" id="L110">                                    return ExtensionFuncInvocationContext(parameters, env)</span>
                                }
                            })
<span class="nc" id="L113">                        val result = sandbox.eval(request.code.value)</span>
//                println(&quot;RESULT: $result&quot;)
//
//                println(&quot;Finish executing task ${request.id}&quot;)

<span class="nc" id="L118">                        DefaultHamalSdk(&quot;http://localhost:8084&quot;).execService().complete(</span>
<span class="nc" id="L119">                            request.id, ExecService.StateAfterCompletion(</span>
<span class="nc" id="L120">                                contentType = &quot;application/json&quot;,</span>
<span class="nc" id="L121">                                bytes = (counter + 1).toString().toByteArray()</span>
                            )
                        )

<span class="nc" id="L125">                    } catch (t: Throwable) {</span>
<span class="nc" id="L126">                        t.printStackTrace()</span>

                    }
<span class="nc" id="L129">                }</span>
<span class="nc" id="L130">        }</span>
<span class="nc" id="L131">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>