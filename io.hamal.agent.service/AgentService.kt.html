<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgentService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bootstrap</a> &gt; <a href="index.source.html" class="el_package">io.hamal.agent.service</a> &gt; <span class="el_source">AgentService.kt</span></div><h1>AgentService.kt</h1><pre class="source lang-java linenums">package io.hamal.agent.service

import io.hamal.agent.adapter.ExtensionLoader
import io.hamal.agent.extension.api.ExtensionFuncInvocationContext
import io.hamal.lib.domain.State
import io.hamal.lib.domain.vo.Content
import io.hamal.lib.domain.vo.ContentType
import io.hamal.lib.script.api.value.EnvValue
import io.hamal.lib.script.api.value.FuncInvocationContextFactory
import io.hamal.lib.script.api.value.IdentValue
import io.hamal.lib.script.api.value.Value
import io.hamal.lib.script.impl.DefaultSandbox
import io.hamal.lib.script.impl.builtin.AssertFunction
import io.hamal.lib.script.impl.builtin.RequireFunction
import io.hamal.lib.sdk.DefaultHamalSdk
import jakarta.annotation.PostConstruct
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.stereotype.Service
import java.io.File
import java.util.concurrent.CompletableFuture
import java.util.concurrent.TimeUnit

<span class="nc" id="L23">@Service</span>
<span class="nc" id="L24">class AgentService {</span>

//    private val functionValues = mutableListOf&lt;FuncValue&gt;()

    //FIXME introduce WorkerExtensionEnvironment as a wrapper around native env
<span class="nc" id="L29">    private val extensionEnvironments = mutableListOf&lt;EnvValue&gt;()</span>

    @PostConstruct
    fun postConstruct() {

<span class="nc" id="L34">        println(&quot;Agent active&quot;)</span>

<span class="nc" id="L36">        val entryPointLoader = ExtensionLoader.DefaultImpl()</span>

//        val s =
//            entryPointLoader.load(
//                File(&quot;/home/ddymke/Repo/hamal/worker/extension/impl/web3/build/libs/extension-starter.jar&quot;)
//            )
//        nativeFunctions.addAll(s.functionFactories())

//        val x =
//            entryPointLoader.load(
//                File(&quot;/home/ddymke/Repo/hamal/agent/extension/impl/web3/build/libs/extension-web3.jar&quot;)
//            )
//
//
//        extensionEnvironments.add(x.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times

<span class="nc" id="L52">        val log =</span>
<span class="nc" id="L53">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/log/build/libs/extension-std-log.jar&quot;))</span>
<span class="nc" id="L54">        extensionEnvironments.add(log.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

<span class="nc" id="L56">        val sys =</span>
<span class="nc" id="L57">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/sys/build/libs/extension-std-sys.jar&quot;))</span>
<span class="nc" id="L58">        extensionEnvironments.add(sys.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

<span class="nc" id="L60">        val debug =</span>
<span class="nc" id="L61">            entryPointLoader.load(File(&quot;/home/ddymke/Repo/hamal/agent/extension/std/debug/build/libs/extension-std-debug.jar&quot;))</span>
<span class="nc" id="L62">        extensionEnvironments.add(debug.create()) // FIXME store the factory not the environment - a new environment must be created when calling require each times</span>

//        x.functionFactories()

//            .map { it.create() }
//            .forEach { it(DefaultContext()) }


<span class="nc" id="L70">    }</span>

    @Scheduled(initialDelay = 100, fixedDelay = 1000, timeUnit = TimeUnit.MILLISECONDS)
    fun run() {
<span class="nc" id="L74">        CompletableFuture.runAsync {</span>
<span class="nc" id="L75">            DefaultHamalSdk(&quot;http://localhost:8084&quot;).execService()</span>
<span class="nc" id="L76">                .poll()</span>
<span class="nc" id="L77">                .requests.forEach { request -&gt;</span>

<span class="nc" id="L79">                    try {</span>

<span class="nc" id="L81">                        println(&quot;${request.inputs} - ${request.inputs.value}&quot;)</span>
<span class="nc" id="L82">                        println(&quot;${request.secrets} - ${request.secrets.value.size}&quot;)</span>

//                println(&quot;$request&quot;)
//                println(&quot;Execute: ${request.id} - ${request.correlation}&quot;)
//                println(&quot;State: ${request.statePayload}&quot;)
//
//                        val counter = (request.statePayload?.content?.let { String(it) } ?: &quot;0&quot;).toInt()
//                println(counter)

<span class="nc" id="L91">                        val env = EnvValue(</span>
<span class="nc" id="L92">                            ident = IdentValue(&quot;_G&quot;),</span>
<span class="nc" id="L93">                            values = mapOf(</span>
<span class="nc" id="L94">                                IdentValue(&quot;assert&quot;) to AssertFunction,</span>
<span class="nc" id="L95">                                IdentValue(&quot;require&quot;) to RequireFunction</span>
                            )
                        )


<span class="nc" id="L100">                        extensionEnvironments.forEach { environment -&gt;</span>
<span class="nc" id="L101">                            env.addGlobal(environment.ident, environment)</span>
<span class="nc" id="L102">                        }</span>


<span class="nc" id="L105">                        val sandbox = DefaultSandbox(</span>
<span class="nc" id="L106">                            env,</span>
<span class="nc" id="L107">                            object : FuncInvocationContextFactory&lt;ExtensionFuncInvocationContext&gt; {</span>
                                override fun create(
                                    parameters: List&lt;Value&gt;,
                                    env: EnvValue
                                ): ExtensionFuncInvocationContext {
<span class="nc" id="L112">                                    return ExtensionFuncInvocationContext(parameters, env)</span>
                                }
                            })
<span class="nc" id="L115">                        val result = sandbox.eval(request.code.value)</span>
//                println(&quot;RESULT: $result&quot;)
//
//                println(&quot;Finish executing task ${request.id}&quot;)

<span class="nc" id="L120">                        DefaultHamalSdk(&quot;http://localhost:8084&quot;).execService().complete(</span>
<span class="nc" id="L121">                            request.id, State(</span>
<span class="nc" id="L122">                                contentType = ContentType(&quot;application/json&quot;),</span>
<span class="nc" id="L123">                                content = Content(&quot;&quot;)</span>
                            )
                        )

<span class="nc" id="L127">                    } catch (t: Throwable) {</span>
<span class="nc" id="L128">                        t.printStackTrace()</span>

                    }
<span class="nc" id="L131">                }</span>
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>