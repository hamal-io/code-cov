<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogExtension.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mono</a> &gt; <a href="index.source.html" class="el_package">io.hamal.extension.std.log</a> &gt; <span class="el_source">LogExtension.kt</span></div><h1>LogExtension.kt</h1><pre class="source lang-java linenums">package io.hamal.extension.std.log

import io.hamal.lib.domain._enum.ExecLogLevel
import io.hamal.lib.domain.vo.ExecId
import io.hamal.lib.domain.vo.ExecLogMessage
import io.hamal.lib.domain.vo.LocalAt
import io.hamal.lib.kua.extension.ScriptExtension
import io.hamal.lib.kua.extension.ScriptExtensionFactory
import io.hamal.lib.kua.function.Function2In1Out
import io.hamal.lib.kua.function.FunctionContext
import io.hamal.lib.kua.function.FunctionInput2Schema
import io.hamal.lib.kua.function.FunctionOutput1Schema
import io.hamal.lib.kua.type.ErrorType
import io.hamal.lib.kua.type.StringType
import io.hamal.lib.sdk.HttpTemplateSupplier
import io.hamal.lib.sdk.domain.AppendExecLogCmd
import io.hamal.lib.sdk.service.DefaultExecLogService
import logger


<span class="nc" id="L21">val log = logger(LogFunction::class)</span>

<span class="fc" id="L23">class LogExtensionFactory(</span>
<span class="fc" id="L24">    private val templateSupplier: HttpTemplateSupplier</span>
) : ScriptExtensionFactory {
    override fun create(): ScriptExtension {
<span class="fc" id="L27">        return ScriptExtension(</span>
<span class="fc" id="L28">            name = &quot;log&quot;,</span>
<span class="fc" id="L29">            internals = mapOf(</span>
<span class="fc" id="L30">                &quot;log&quot; to LogFunction(templateSupplier),</span>
            )
        )
    }
}

<span class="fc" id="L36">class LogFunction(</span>
<span class="fc" id="L37">    private val templateSupplier: HttpTemplateSupplier</span>
<span class="fc" id="L38">) : Function2In1Out&lt;StringType, StringType, ErrorType&gt;(</span>
<span class="fc" id="L39">    FunctionInput2Schema(StringType::class, StringType::class),</span>
<span class="fc" id="L40">    FunctionOutput1Schema(ErrorType::class)</span>
) {

    override fun invoke(ctx: FunctionContext, arg1: StringType, arg2: StringType): ErrorType? {
<span class="nc" id="L44">        val level = ExecLogLevel.valueOf(arg1.value)</span>
<span class="nc" id="L45">        val message = ExecLogMessage(arg2.value)</span>


<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (level == ExecLogLevel.Info) {</span>
<span class="nc" id="L49">            log.info(message.value)</span>
        }


<span class="nc" id="L53">        DefaultExecLogService(templateSupplier())</span>
<span class="nc" id="L54">            .append(</span>
<span class="nc" id="L55">                ctx[ExecId::class],</span>
<span class="nc" id="L56">                AppendExecLogCmd(</span>
<span class="nc" id="L57">                    level = level,</span>
<span class="nc" id="L58">                    message = message,</span>
<span class="nc" id="L59">                    localAt = LocalAt.now()</span>
                )
            )

<span class="nc" id="L63">        return null</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>