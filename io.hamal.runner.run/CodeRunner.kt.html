<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CodeRunner.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mono</a> &gt; <a href="index.source.html" class="el_package">io.hamal.runner.run</a> &gt; <span class="el_source">CodeRunner.kt</span></div><h1>CodeRunner.kt</h1><pre class="source lang-java linenums">package io.hamal.runner.run

import io.hamal.lib.domain.Invocation
import io.hamal.lib.domain.State
import io.hamal.lib.domain.vo.ExecId
import io.hamal.lib.kua.AssertionError
import io.hamal.lib.kua.ExitError
import io.hamal.lib.kua.ExtensionError
import io.hamal.lib.kua.function.FunctionType
import io.hamal.lib.kua.table.TableProxyArray
import io.hamal.lib.kua.table.TableProxyMap
import io.hamal.lib.kua.type.ErrorType
import io.hamal.lib.kua.type.NumberType
import io.hamal.lib.kua.type.StringType
import io.hamal.runner.config.SandboxFactory
import io.hamal.runner.connector.Connector
import io.hamal.runner.connector.UnitOfWork
import logger

interface CodeRunner {
    operator fun invoke(unitOfWork: UnitOfWork)
}

<span class="fc" id="L24">class DefaultCodeRunner(</span>
<span class="fc" id="L25">    private val connector: Connector,</span>
<span class="fc" id="L26">    private val sandboxFactory: SandboxFactory</span>
) : CodeRunner {

    private lateinit var executionContext: RunnerSandboxContext

<span class="pc bpc" id="L31" title="1 of 2 branches missed.">    val context get() = executionContext</span>

    override fun invoke(unitOfWork: UnitOfWork) {
<span class="fc" id="L34">        val execId = unitOfWork.id</span>
<span class="fc" id="L35">        try {</span>
<span class="fc" id="L36">            log.debug(&quot;Start execution: $execId&quot;)</span>

<span class="fc" id="L38">            executionContext = RunnerSandboxContext()</span>
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">            executionContext[ExecId::class] = unitOfWork.id</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">            executionContext[Invocation::class] = unitOfWork.invocation</span>

<span class="pc bpc" id="L42" title="1 of 2 branches missed.">            sandboxFactory.create(executionContext)</span>
<span class="fc" id="L43">                .use { sandbox -&gt;</span>

<span class="pc bpc" id="L45" title="1 of 2 branches missed.">                    val ctxExtension = RunnerContextFactory(executionContext).create(sandbox)</span>

<span class="fc" id="L47">                    val internalTable = sandbox.state.tableCreateMap(ctxExtension.internals.size)</span>
<span class="fc" id="L48">                    ctxExtension.internals.forEach { entry -&gt;</span>
<span class="fc" id="L49">                        when (val value = entry.value) {</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">                            is StringType -&gt; internalTable[entry.key] = value</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">                            is NumberType -&gt; internalTable[entry.key] = value</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">                            is FunctionType&lt;*, *, *, *&gt; -&gt; internalTable[entry.key] = value</span>
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">                            is TableProxyArray -&gt; internalTable[entry.key] = value</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">                            is TableProxyMap -&gt; internalTable[entry.key] = value</span>

<span class="nc" id="L56">                            else -&gt; TODO()</span>
                        }
<span class="fc" id="L58">                    }</span>


<span class="fc" id="L61">                    sandbox.setGlobal(&quot;_internal&quot;, internalTable)</span>
<span class="fc" id="L62">                    sandbox.state.load(ctxExtension.init)</span>
<span class="fc" id="L63">                    sandbox.state.load(&quot;${ctxExtension.name} = create_extension_factory()()&quot;)</span>
<span class="fc" id="L64">                    sandbox.unsetGlobal(&quot;_internal&quot;)</span>

<span class="fc" id="L66">                    sandbox.load(unitOfWork.code)</span>
<span class="fc" id="L67">                }</span>

<span class="pc bpc" id="L69" title="1 of 2 branches missed.">            connector.complete(execId, State(), executionContext.runnerEmittedEvents)</span>
<span class="fc" id="L70">            log.debug(&quot;Completed exec: $execId&quot;)</span>

<span class="fc" id="L72">        } catch (e: ExtensionError) {</span>
<span class="fc" id="L73">            e.printStackTrace()</span>
<span class="fc" id="L74">            val cause = e.cause</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            if (cause is ExitError) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (cause.status == NumberType(0.0)) {</span>
<span class="nc" id="L77">                    connector.complete(execId, State(), listOf())</span>
<span class="nc" id="L78">                    log.debug(&quot;Completed exec: $execId&quot;)</span>
                } else {
<span class="nc bnc" id="L80" title="All 2 branches missed.">                    connector.fail(execId, ErrorType(e.message ?: &quot;Unknown reason&quot;))</span>
<span class="nc" id="L81">                    log.debug(&quot;Failed exec: $execId&quot;)</span>
                }
            } else {
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                connector.fail(execId, ErrorType(e.message ?: &quot;Unknown reason&quot;))</span>
<span class="fc" id="L85">                log.debug(&quot;Failed exec: $execId&quot;)</span>
            }
<span class="nc" id="L87">        } catch (a: AssertionError) {</span>
<span class="nc" id="L88">            a.printStackTrace()</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            connector.fail(execId, ErrorType(a.message ?: &quot;Unknown reason&quot;))</span>
<span class="nc" id="L90">            log.debug(&quot;Assertion error: $execId - ${a.message}&quot;)</span>
<span class="fc" id="L91">        } catch (t: Throwable) {</span>
<span class="fc" id="L92">            t.printStackTrace()</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">            connector.fail(execId, ErrorType(t.message ?: &quot;Unknown reason&quot;))</span>
<span class="nc" id="L94">            log.debug(&quot;Failed exec: $execId&quot;)</span>
        }
<span class="fc" id="L96">    }</span>

    companion object {
<span class="fc" id="L99">        private val log = logger(DefaultCodeRunner::class)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>