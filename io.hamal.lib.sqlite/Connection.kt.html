<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Connection.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mono</a> &gt; <a href="index.source.html" class="el_package">io.hamal.lib.sqlite</a> &gt; <span class="el_source">Connection.kt</span></div><h1>Connection.kt</h1><pre class="source lang-java linenums">package io.hamal.lib.sqlite

import io.hamal.lib.common.SnowflakeId
import io.hamal.lib.common.domain.CmdId
import io.hamal.lib.common.domain.DomainId
import io.hamal.lib.common.domain.DomainName
import io.hamal.lib.common.domain.Limit
import io.hamal.lib.sqlite.DefaultNamedPreparedStatement.Companion.prepare
import io.hamal.lib.sqlite.Transaction.AbortException
import logger
import java.math.BigInteger
import java.sql.DriverManager
import java.time.Instant
import java.util.concurrent.locks.ReentrantLock
import kotlin.concurrent.withLock
import kotlin.reflect.KClass

<span class="fc" id="L18">class NamedPreparedStatementDelegate(</span>
<span class="pc" id="L19">    val delegate: NamedPreparedStatement&lt;*&gt;</span>
) {
    operator fun set(
        param: String,
        value: Boolean
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L25">        delegate[param] = value</span>
<span class="fc" id="L26">        return this</span>
    }

    operator fun set(
        param: String,
        value: Int
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L33">        delegate[param] = value</span>
<span class="fc" id="L34">        return this</span>
    }

    operator fun set(
        param: String,
        value: UInt
    ): NamedPreparedStatementDelegate {
<span class="nc" id="L41">        delegate[param] = value.toInt()</span>
<span class="nc" id="L42">        return this</span>
    }

    operator fun set(
        param: String,
        value: UShort
    ): NamedPreparedStatementDelegate {
<span class="nc" id="L49">        delegate[param] = value.toInt()</span>
<span class="nc" id="L50">        return this</span>
    }


    operator fun set(
        param: String,
        value: BigInteger
    ): NamedPreparedStatementDelegate {
<span class="nc" id="L58">        delegate[param] = value</span>
<span class="nc" id="L59">        return this</span>
    }

    operator fun set(
        param: String,
        value: Limit
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L66">        delegate[param] = value.value</span>
<span class="fc" id="L67">        return this</span>
    }

    operator fun set(
        param: String,
        value: Long
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L74">        delegate[param] = value</span>
<span class="fc" id="L75">        return this</span>
    }

    operator fun set(
        param: String,
        value: ULong
    ): NamedPreparedStatementDelegate {
<span class="nc" id="L82">        delegate[param] = value.toLong()</span>
<span class="nc" id="L83">        return this</span>
    }

    operator fun set(
        param: String,
        value: Instant
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L90">        delegate[param] = value</span>
<span class="fc" id="L91">        return this</span>
    }

    operator fun set(
        param: String,
        value: SnowflakeId
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L98">        delegate[param] = value</span>
<span class="fc" id="L99">        return this</span>
    }

    operator fun set(
        param: String,
        value: DomainId
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L106">        delegate[param] = value</span>
<span class="fc" id="L107">        return this</span>
    }

    operator fun set(
        param: String,
        value: DomainName
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L114">        delegate[param] = value</span>
<span class="fc" id="L115">        return this</span>
    }

    operator fun set(
        param: String,
        value: CmdId
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L122">        delegate[param] = value</span>
<span class="fc" id="L123">        return this</span>
    }

    operator fun set(
        param: String,
        value: ByteArray
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L130">        delegate[param] = value</span>
<span class="fc" id="L131">        return this</span>
    }

    operator fun set(
        param: String,
        value: String
    ): NamedPreparedStatementDelegate {
<span class="fc" id="L138">        delegate[param] = value</span>
<span class="fc" id="L139">        return this</span>
    }
}

<span class="fc" id="L143">class NamedPreparedStatementResultSetDelegate&lt;RESULT : Any&gt;(</span>
<span class="pc" id="L144">    internal val delegate: NamedPreparedStatementDelegate</span>
) {

    private var mapping: ((NamedResultSet) -&gt; RESULT)? = null

    fun query(
        block: NamedPreparedStatementDelegate.() -&gt; NamedPreparedStatementDelegate
    ): NamedPreparedStatementResultSetDelegate&lt;RESULT&gt; {
<span class="fc" id="L152">        block(delegate)</span>
<span class="fc" id="L153">        return this</span>
    }

    fun map(mapper: (NamedResultSet) -&gt; RESULT): NamedPreparedStatementResultSetDelegate&lt;RESULT&gt; {
<span class="fc" id="L157">        this.mapping = mapper</span>
<span class="fc" id="L158">        return this</span>
    }

    internal fun apply(namedResultSet: NamedResultSet): List&lt;RESULT&gt; {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        val fn = mapping ?: return listOf()</span>
<span class="fc" id="L163">        return namedResultSet.map(fn)</span>
    }
}


interface Connection : AutoCloseable {
    val isOpen: Boolean
    val isClosed: Boolean
    fun prepare(sql: String): NamedPreparedStatement&lt;*&gt;
    fun execute(sql: String)
    fun execute(
        sql: String,
        block: NamedPreparedStatementDelegate.() -&gt; NamedPreparedStatementDelegate
    )

    fun &lt;T : Any&gt; execute(
        sql: String,
        block: NamedPreparedStatementResultSetDelegate&lt;T&gt;.() -&gt; NamedPreparedStatementResultSetDelegate&lt;T&gt;
    ): T?

    fun executeUpdate(sql: String): Int
    fun executeUpdate(
        sql: String,
        block: NamedPreparedStatementDelegate.() -&gt; NamedPreparedStatementDelegate
    ): Int

    fun &lt;T : Any&gt; executeQuery(
        sql: String,
        block: NamedPreparedStatementResultSetDelegate&lt;T&gt;.() -&gt; NamedPreparedStatementResultSetDelegate&lt;T&gt;
    ): List&lt;T&gt;

    fun executeQuery(
        sql: String,
        block: (NamedResultSet) -&gt; Unit
    )

    fun &lt;T : Any&gt; executeQueryOne(
        sql: String,
        block: NamedPreparedStatementResultSetDelegate&lt;T&gt;.() -&gt; NamedPreparedStatementResultSetDelegate&lt;T&gt;
<span class="fc" id="L202">    ): T? = executeQuery(sql, block).firstOrNull()</span>

    fun &lt;T&gt; tx(block: Transaction.() -&gt; T): T
}

<span class="fc" id="L207">class DefaultConnection(</span>
    owningClass: KClass&lt;*&gt;,
    url: String
) : Connection {

<span class="fc" id="L212">    val delegate: java.sql.Connection</span>
<span class="fc" id="L213">    private val log = logger(owningClass)</span>
<span class="fc" id="L214">    private val lock = ReentrantLock()</span>

<span class="fc" id="L216">    init {</span>
<span class="fc" id="L217">        delegate = DriverManager.getConnection(url)</span>
<span class="fc" id="L218">        log.trace(&quot;Open sqlite connection with url: $url&quot;)</span>
<span class="fc" id="L219">    }</span>

<span class="fc bfc" id="L221" title="All 2 branches covered.">    override val isOpen: Boolean get() = !delegate.isClosed</span>
<span class="fc" id="L222">    override val isClosed: Boolean get() = delegate.isClosed</span>

    override fun prepare(sql: String): NamedPreparedStatement&lt;*&gt; {
<span class="fc" id="L225">        log.trace(&quot;Prepare statement: $sql&quot;)</span>
<span class="fc" id="L226">        val result = delegate.prepare(sql)</span>
<span class="fc" id="L227">        log.trace(&quot;Prepared statement: ${result.sql}&quot;)</span>
<span class="fc" id="L228">        return result</span>
    }

    override fun execute(sql: String) {
<span class="fc" id="L232">        prepare(sql).use {</span>
<span class="fc" id="L233">            log.debug(&quot;Execute: ${it.sql}&quot;)</span>
<span class="fc" id="L234">            it.execute()</span>
        }
<span class="fc" id="L236">    }</span>

    override fun execute(
        sql: String,
        block: NamedPreparedStatementDelegate.() -&gt; NamedPreparedStatementDelegate
    ) {
<span class="fc" id="L242">        prepare(sql).use {</span>
<span class="fc" id="L243">            block(NamedPreparedStatementDelegate(it))</span>
<span class="fc" id="L244">            log.debug(&quot;Execute: ${it.sql}&quot;)</span>
<span class="fc" id="L245">            it.execute()</span>
        }
<span class="fc" id="L247">    }</span>

    override fun &lt;T : Any&gt; execute(
        sql: String,
        block: NamedPreparedStatementResultSetDelegate&lt;T&gt;.() -&gt; NamedPreparedStatementResultSetDelegate&lt;T&gt;
    ): T? {
<span class="fc" id="L253">        val it = prepare(sql)</span>
<span class="fc" id="L254">        val delegate = NamedPreparedStatementResultSetDelegate&lt;T&gt;(</span>
<span class="fc" id="L255">            NamedPreparedStatementDelegate(it)</span>
        )
<span class="fc" id="L257">        block(delegate)</span>
<span class="fc" id="L258">        log.debug(&quot;Execute : ${it.sql}&quot;)</span>
<span class="pc bpc" id="L259" title="2 of 4 branches missed.">        return it.execute()?.let(delegate::apply)?.firstOrNull()</span>
    }

    override fun executeUpdate(sql: String): Int {
<span class="pc" id="L263">        return prepare(sql).use {</span>
<span class="fc" id="L264">            log.debug(&quot;Execute update: ${it.sql}&quot;)</span>
<span class="nc" id="L265">            it.executeUpdate()</span>
        }
    }

    override fun executeUpdate(
        sql: String,
        block: NamedPreparedStatementDelegate.() -&gt; NamedPreparedStatementDelegate
    ): Int {
<span class="pc" id="L273">        return prepare(sql).use {</span>
<span class="fc" id="L274">            block(NamedPreparedStatementDelegate(it))</span>
<span class="fc" id="L275">            log.debug(&quot;Execute update: ${it.sql}&quot;)</span>
<span class="fc" id="L276">            it.executeUpdate()</span>
        }
    }

    override fun &lt;T : Any&gt; executeQuery(
        sql: String,
        block: NamedPreparedStatementResultSetDelegate&lt;T&gt;.() -&gt; NamedPreparedStatementResultSetDelegate&lt;T&gt;
    ): List&lt;T&gt; {
<span class="fc" id="L284">        return prepare(sql).use {</span>
<span class="fc" id="L285">            val delegate =</span>
<span class="fc" id="L286">                NamedPreparedStatementResultSetDelegate&lt;T&gt;(</span>
<span class="fc" id="L287">                    NamedPreparedStatementDelegate(it)</span>
                )
<span class="fc" id="L289">            block(delegate)</span>
<span class="fc" id="L290">            log.debug(&quot;Execute query: ${it.sql}&quot;)</span>
<span class="fc" id="L291">            delegate.apply(it.executeQuery())</span>
        }
    }

    override fun executeQuery(sql: String, block: (NamedResultSet) -&gt; Unit) {
<span class="pc" id="L296">        return prepare(sql).use {</span>
<span class="fc" id="L297">            log.debug(&quot;Execute query: ${it.sql}&quot;)</span>
<span class="fc" id="L298">            block(it.executeQuery())</span>
<span class="fc" id="L299">        }</span>
    }

    override fun &lt;T&gt; tx(block: Transaction.() -&gt; T): T {
<span class="fc" id="L303">        return lock.withLock {</span>
<span class="fc" id="L304">            delegate.autoCommit = false</span>
<span class="fc" id="L305">            try {</span>
<span class="fc" id="L306">                log.trace(&quot;Transaction started&quot;)</span>
<span class="fc" id="L307">                val result = block(DefaultTransaction(this))</span>
<span class="fc" id="L308">                delegate.commit()</span>
<span class="fc" id="L309">                log.trace(&quot;Transaction committed&quot;)</span>
<span class="fc" id="L310">                result</span>
<span class="fc" id="L311">            } catch (a: AbortException) {</span>
<span class="fc" id="L312">                log.info(&quot;Transaction aborted&quot;)</span>
<span class="fc" id="L313">                delegate.rollback()</span>
<span class="fc" id="L314">                throw a</span>
<span class="fc" id="L315">            } catch (t: Throwable) {</span>
<span class="fc" id="L316">                log.warn(&quot;Transaction rolled back due to $t&quot;)</span>
<span class="fc" id="L317">                delegate.rollback()</span>
<span class="fc" id="L318">                throw t</span>
            } finally {
<span class="fc" id="L320">                log.trace(&quot;Transaction completed&quot;)</span>
<span class="fc" id="L321">                delegate.autoCommit = true</span>
            }
        }
    }

    override fun close() {
<span class="fc" id="L327">        delegate.close()</span>
<span class="fc" id="L328">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>