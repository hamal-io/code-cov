<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NamedPreparedStatement.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bootstrap</a> &gt; <a href="index.source.html" class="el_package">io.hamal.backend.repository.sqlite.internal</a> &gt; <span class="el_source">NamedPreparedStatement.kt</span></div><h1>NamedPreparedStatement.kt</h1><pre class="source lang-java linenums">package io.hamal.backend.repository.sqlite.internal

//Inspired by: https://github.com/axiom-data-science/jdbc-named-parameters/blob/master/src/main/java/com/axiomalaska/jdbc/NamedParameterPreparedStatement.java

import io.hamal.backend.repository.sqlite.internal.NamedPreparedStatement.ParseResult
import io.hamal.lib.common.KeyedOnce
import io.hamal.lib.common.SnowflakeId
import io.hamal.lib.common.util.TokenizerUtils
import io.hamal.lib.domain.CmdId
import io.hamal.lib.domain.vo.base.DomainId
import io.hamal.lib.domain.vo.base.DomainName
import java.sql.Connection
import java.sql.PreparedStatement
import java.sql.Timestamp
import java.time.Instant


interface NamedPreparedStatement&lt;STATEMENT&gt; : AutoCloseable {
    val sql: String
    val orderedParameters: List&lt;String&gt;
    operator fun set(parameter: String, value: Boolean): STATEMENT
    operator fun set(parameter: String, value: Int): STATEMENT
    operator fun set(parameter: String, value: Long): STATEMENT
    operator fun set(parameter: String, value: Instant): STATEMENT
    operator fun set(parameter: String, value: String): STATEMENT
    operator fun set(parameter: String, value: SnowflakeId): STATEMENT
    operator fun set(parameter: String, value: CmdId): STATEMENT
    operator fun set(parameter: String, value: DomainId): STATEMENT
    operator fun set(parameter: String, value: DomainName): STATEMENT
    operator fun set(parameter: String, value: ByteArray): STATEMENT
    fun execute(): NamedResultSet?
    fun executeUpdate(): Int
    fun executeQuery(): NamedResultSet
<span class="fc" id="L34">    class ParseResult(val sql: String, val orderedParameters: List&lt;String&gt;)</span>
}


<span class="fc" id="L38">class DefaultNamedPreparedStatement(</span>
<span class="pc" id="L39">    internal val delegate: PreparedStatement,</span>
<span class="fc" id="L40">    internal val parseResult: ParseResult</span>
) : NamedPreparedStatement&lt;DefaultNamedPreparedStatement&gt; {

<span class="fc" id="L43">    internal val parametersSet = mutableSetOf&lt;String&gt;()</span>

    companion object {
<span class="fc" id="L46">        private val cachedSql = KeyedOnce.default&lt;String, ParseResult&gt;()</span>
        fun Connection.prepare(query: String): NamedPreparedStatement&lt;DefaultNamedPreparedStatement&gt; {
<span class="fc" id="L48">            return cachedSql(query) { Parser().parse(query) }</span>
<span class="fc" id="L49">                .let {</span>
<span class="fc" id="L50">                    val stmt = prepareStatement(it.sql)</span>
<span class="fc" id="L51">                    DefaultNamedPreparedStatement(stmt, it)</span>
                }
        }
    }


<span class="fc" id="L57">    override val sql: String get() = parseResult.sql</span>
<span class="nc" id="L58">    override val orderedParameters: List&lt;String&gt; get() = parseResult.orderedParameters</span>

    override fun set(parameter: String, value: Boolean): DefaultNamedPreparedStatement {
<span class="fc" id="L61">        parametersSet.add(parameter)</span>
<span class="fc" id="L62">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setBoolean(it, value) }</span>
<span class="fc" id="L63">        return this</span>
    }

    override fun set(parameter: String, value: Int): DefaultNamedPreparedStatement {
<span class="fc" id="L67">        parametersSet.add(parameter)</span>
<span class="fc" id="L68">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setInt(it, value) }</span>
<span class="fc" id="L69">        return this</span>
    }

    override fun set(parameter: String, value: Long): DefaultNamedPreparedStatement {
<span class="fc" id="L73">        parametersSet.add(parameter)</span>
<span class="fc" id="L74">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setLong(it, value) }</span>
<span class="fc" id="L75">        return this</span>
    }

    override fun set(parameter: String, value: Instant): DefaultNamedPreparedStatement {
<span class="fc" id="L79">        parametersSet.add(parameter)</span>
<span class="fc" id="L80">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setTimestamp(it, Timestamp.from(value)) }</span>
<span class="fc" id="L81">        return this</span>
    }

    override fun set(parameter: String, value: SnowflakeId): DefaultNamedPreparedStatement {
<span class="nc" id="L85">        parametersSet.add(parameter)</span>
<span class="nc" id="L86">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setLong(it, value.value) }</span>
<span class="nc" id="L87">        return this</span>
    }

    override fun set(parameter: String, value: CmdId): DefaultNamedPreparedStatement {
<span class="fc" id="L91">        parametersSet.add(parameter)</span>
<span class="fc" id="L92">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setBigDecimal(it, value.value.toBigDecimal()) }</span>
<span class="fc" id="L93">        return this</span>
    }

    override fun set(parameter: String, value: DomainId): DefaultNamedPreparedStatement {
<span class="fc" id="L97">        parametersSet.add(parameter)</span>
<span class="fc" id="L98">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setLong(it, value.value.value) }</span>
<span class="fc" id="L99">        return this</span>
    }

    override fun set(parameter: String, value: DomainName): DefaultNamedPreparedStatement {
<span class="nc" id="L103">        parametersSet.add(parameter)</span>
<span class="nc" id="L104">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setString(it, value.value) }</span>
<span class="nc" id="L105">        return this</span>
    }

    override fun set(parameter: String, value: ByteArray): DefaultNamedPreparedStatement {
<span class="fc" id="L109">        parametersSet.add(parameter)</span>
<span class="fc" id="L110">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setBytes(it, value) }</span>
<span class="fc" id="L111">        return this</span>
    }

    override fun set(parameter: String, value: String): DefaultNamedPreparedStatement {
<span class="fc" id="L115">        parametersSet.add(parameter)</span>
<span class="fc" id="L116">        parametersSet.add(parameter)</span>
<span class="fc" id="L117">        parseResult.parameterIndexesOf(parameter).forEach { delegate.setString(it, value) }</span>
<span class="fc" id="L118">        return this</span>
    }

    override fun execute(): NamedResultSet? {
<span class="fc" id="L122">        ensureAllParametersSet()</span>
<span class="fc" id="L123">        delegate.execute()</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        val rs = delegate.resultSet ?: return null</span>
<span class="fc" id="L125">        return DefaultNamedResultSet(rs)</span>
    }

    override fun executeUpdate(): Int {
<span class="nc" id="L129">        ensureAllParametersSet()</span>
<span class="nc" id="L130">        return delegate.executeUpdate()</span>
    }

    override fun executeQuery(): NamedResultSet {
<span class="fc" id="L134">        ensureAllParametersSet()</span>
<span class="fc" id="L135">        return DefaultNamedResultSet(delegate.executeQuery())</span>
    }

    override fun close() {
<span class="fc" id="L139">        delegate.close()</span>
<span class="fc" id="L140">    }</span>

    private fun ParseResult.parameterIndexesOf(parameter: String): Iterable&lt;Int&gt; {
<span class="fc" id="L143">        val result = orderedParameters.mapIndexedNotNull { index, orderedParameter -&gt;</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">            if (parameter == orderedParameter) {</span>
<span class="fc" id="L145">                index + 1</span>
            } else {
<span class="fc" id="L147">                null</span>
            }
        }
<span class="pc bpc" id="L150" title="2 of 4 branches missed.">        require(result.isNotEmpty()) { &quot;Statement does not contain parameter $parameter&quot; }</span>
<span class="fc" id="L151">        return result</span>
    }
}

internal fun DefaultNamedPreparedStatement.ensureAllParametersSet() {
<span class="fc" id="L156">    val diff = this.parseResult.orderedParameters.toSet()</span>
<span class="fc" id="L157">        .subtract(parametersSet)</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">    require(diff.isEmpty()) { &quot;Expected all named parameters to be set, but $diff are missing&quot; }</span>
<span class="fc" id="L159">}</span>

<span class="fc" id="L161">internal class Parser {</span>
<span class="fc" id="L162">    private var query: String = &quot;&quot;</span>
    private var position: Int = 0
<span class="fc" id="L164">    private var resultBuffer: StringBuffer = StringBuffer()</span>
<span class="fc" id="L165">    private var orderedParameters: MutableList&lt;String&gt; = mutableListOf()</span>

    fun parse(query: String): ParseResult {
<span class="fc" id="L168">        initParser(query)</span>

<span class="fc bfc" id="L170" title="All 2 branches covered.">        while (!isAtEnd()) {</span>
<span class="fc" id="L171">            val current = peek()</span>
<span class="fc" id="L172">            when {</span>
<span class="fc bfc" id="L173" title="All 4 branches covered.">                current == ':' &amp;&amp; peekNext() == ':' -&gt; {</span>
<span class="fc" id="L174">                    advance()</span>
<span class="fc" id="L175">                    advance()</span>
                }

<span class="pc bpc" id="L178" title="1 of 4 branches missed.">                current == ':' &amp;&amp; peekNext() != ':' -&gt; {</span>
<span class="fc" id="L179">                    skip()</span>
<span class="fc" id="L180">                    orderedParameters.add(parseParameter())</span>
<span class="fc" id="L181">                    resultBuffer.append(&quot; ? &quot;)</span>
                }

<span class="fc bfc" id="L184" title="All 2 branches covered.">                current == '-' -&gt; {</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">                    if (peekNext() == '-') {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">                        while (!isAtEnd()) {</span>
<span class="fc" id="L187">                            when (peek()) {</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                                '\n' -&gt; break</span>
<span class="fc" id="L189">                                else -&gt; skip()</span>
                            }
                        }
                    }
                }

<span class="pc bpc" id="L195" title="1 of 4 branches missed.">                current == '/' &amp;&amp; peekNext() == '*' -&gt; {</span>
<span class="fc" id="L196">                    skip()</span>
<span class="fc" id="L197">                    skip()</span>
<span class="fc" id="L198">                    while (true) {</span>
<span class="fc" id="L199">                        skipUntil('*')</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                        if (current == '/') {</span>
<span class="fc" id="L201">                            skip()</span>
<span class="fc" id="L202">                            break</span>
                        }
                    }

                }

<span class="fc bfc" id="L208" title="All 2 branches covered.">                current == '\'' -&gt; {</span>
<span class="fc" id="L209">                    advance()</span>
<span class="fc" id="L210">                    advanceUntil('\'')</span>
                }

<span class="fc bfc" id="L213" title="All 2 branches covered.">                current == '\&quot;' -&gt; {</span>
<span class="fc" id="L214">                    advance()</span>
<span class="fc" id="L215">                    advanceUntil('\&quot;')</span>
                }

<span class="fc bfc" id="L218" title="All 2 branches covered.">                current == '\n' -&gt; {</span>
<span class="fc" id="L219">                    skip()</span>
<span class="fc" id="L220">                    resultBuffer.append(&quot; &quot;)</span>
                }

<span class="fc" id="L223">                else -&gt; advance()</span>
            }
        }

<span class="fc" id="L227">        return ParseResult(resultBuffer.replace(Regex(&quot;\\s{2,}&quot;), &quot; &quot;).trim(), orderedParameters)</span>
    }

    private fun parseParameter(): String {
<span class="fc" id="L231">        val resultBuilder = StringBuilder()</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        while (!isAtEnd()) {</span>
<span class="fc" id="L233">            val current = peek()</span>
<span class="fc bfc" id="L234" title="All 8 branches covered.">            if (TokenizerUtils.isWhitespace(current) || current == ';' || current == ',' || current == ')') {</span>
<span class="fc" id="L235">                return resultBuilder.toString()</span>
            } else {
<span class="fc" id="L237">                resultBuilder.append(skip())</span>
            }
        }
<span class="fc" id="L240">        return resultBuilder.toString()</span>
    }

    private fun initParser(query: String) {
<span class="fc" id="L244">        this.query = query</span>
<span class="fc" id="L245">        this.position = 0</span>
<span class="fc" id="L246">        this.resultBuffer = StringBuffer(query.length)</span>
<span class="fc" id="L247">        this.orderedParameters = mutableListOf()</span>
<span class="fc" id="L248">    }</span>

    private fun advanceUntil(marker: Char) {
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        while (!isAtEnd()) {</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">            if (peek() == marker) {</span>
<span class="fc" id="L253">                advance()</span>
<span class="fc" id="L254">                break</span>
            }
<span class="fc" id="L256">            advance()</span>
        }
<span class="fc" id="L258">    }</span>

    private fun skipUntil(marker: Char) {
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        while (!isAtEnd()) {</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">            if (peek() == marker) {</span>
<span class="fc" id="L263">                skip()</span>
<span class="fc" id="L264">                break</span>
            }
<span class="fc" id="L266">            skip()</span>
        }
<span class="fc" id="L268">    }</span>

<span class="fc" id="L270">    private fun peek() = query[position]</span>

<span class="fc" id="L272">    private fun peekNext() = query[position + 1]</span>

    private fun advance(): Char {
<span class="fc" id="L275">        val result = query[position++]</span>
<span class="fc" id="L276">        resultBuffer.append(result)</span>
<span class="fc" id="L277">        return result</span>
    }

    private fun skip(): Char {
<span class="fc" id="L281">        return query[position++]</span>
    }

<span class="fc bfc" id="L284" title="All 2 branches covered.">    private fun isAtEnd() = query.length - 1 &lt; position</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>