<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TableType.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mono</a> &gt; <a href="index.source.html" class="el_package">io.hamal.lib.kua.type</a> &gt; <span class="el_source">TableType.kt</span></div><h1>TableType.kt</h1><pre class="source lang-java linenums">package io.hamal.lib.kua.type

import kotlinx.serialization.ExperimentalSerializationApi
import kotlinx.serialization.KSerializer
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable
import kotlinx.serialization.builtins.MapSerializer
import kotlinx.serialization.descriptors.PrimitiveKind
import kotlinx.serialization.descriptors.PrimitiveSerialDescriptor
import kotlinx.serialization.descriptors.SerialDescriptor
import kotlinx.serialization.encoding.Decoder
import kotlinx.serialization.encoding.Encoder
import kotlin.collections.Map.Entry

typealias TableEntry = Entry&lt;StringType, SerializableType&gt;

<span class="pc bpc" id="L17" title="3 of 9 branches missed.">@SerialName(&quot;TableType&quot;)</span>
@Serializable
<span class="fc" id="L19">data class TableType(</span>
<span class="fc" id="L20">    @Serializable(with = Serializer::class)</span>
<span class="fc bfc" id="L21" title="All 4 branches covered.">    private val entries: MutableMap&lt;StringType, SerializableType&gt; = mutableMapOf(),</span>
) : SerializableType, Collection&lt;TableEntry&gt; {

<span class="fc" id="L24">    constructor(vararg pairs: Pair&lt;Any, SerializableType&gt;) : this() {</span>
<span class="fc" id="L25">        pairs.forEach { pair -&gt;</span>
<span class="fc" id="L26">            when (val key = pair.first) {</span>
<span class="fc bfc" id="L27" title="All 2 branches covered.">                is String -&gt; entries[StringType(key)] = pair.second</span>
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">                is Number -&gt; entries[StringType(key.toString())] = pair.second</span>
<span class="pc bpc" id="L29" title="1 of 2 branches missed.">                is StringType -&gt; entries[key] = pair.second</span>
            }
<span class="fc" id="L31">        }</span>
<span class="fc" id="L32">    }</span>

    operator fun set(key: Int, value: SerializableType) {
<span class="nc" id="L35">        this[StringType(key.toString())] = value</span>
<span class="nc" id="L36">    }</span>

    operator fun set(key: StringType, value: SerializableType) {
<span class="fc" id="L39">        entries[key] = value</span>
<span class="fc" id="L40">    }</span>

    fun setAll(tableValue: TableType) {
<span class="nc" id="L43">        tableValue.entries.forEach { entry -&gt;</span>
<span class="nc" id="L44">            entries[entry.key] = entry.value</span>
<span class="nc" id="L45">        }</span>
<span class="nc" id="L46">    }</span>

<span class="nc" id="L48">    operator fun get(key: Int): Type = get(StringType(key.toString()))</span>
<span class="fc" id="L49">    operator fun get(key: String): Type = get(StringType(key))</span>
<span class="nc" id="L50">    operator fun get(key: Type): Type = when (key) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        is StringType -&gt; get(key)</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        is NumberType -&gt; get(StringType(key.value.toString()))</span>
<span class="nc" id="L53">        else -&gt; TODO()</span>
<span class="nc" id="L54">    }</span>

    operator fun get(key: StringType): Type {
<span class="fc" id="L57">        return entries[key]!!</span>
    }


<span class="fc" id="L61">    fun getStringType(key: String) = entries[(StringType(key))]!! as StringType</span>

    fun remove(key: Int) {
<span class="nc" id="L64">        remove(NumberType(key))</span>
<span class="nc" id="L65">    }</span>

    fun remove(key: Type) {
<span class="nc" id="L68">        entries.remove(key)</span>
<span class="nc" id="L69">    }</span>

<span class="fc" id="L71">    override val size: Int get() = entries.size</span>

<span class="nc" id="L73">    override fun isEmpty() = entries.isEmpty()</span>

    override fun iterator(): Iterator&lt;TableEntry&gt; {
<span class="fc" id="L76">        return entries.asIterable().iterator()</span>
    }

<span class="nc" id="L79">    override fun containsAll(elements: Collection&lt;TableEntry&gt;) = elements.all(::contains)</span>
<span class="nc" id="L80">    override fun contains(element: TableEntry) = TODO() // store.containsKey(element.first)</span>
    override fun equals(other: Any?): Boolean {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (this === other) return true</span>
<span class="pc bpc" id="L83" title="2 of 4 branches missed.">        if (javaClass != other?.javaClass) return false</span>

<span class="fc" id="L85">        other as TableType</span>

<span class="fc" id="L87">        return entries == other.entries</span>
    }

    override fun hashCode(): Int {
<span class="nc" id="L91">        return entries.hashCode()</span>
    }

    override fun toString(): String {
<span class="nc" id="L95">        val valueString = entries.map { &quot;(${it.key},${it.value})&quot; }.joinToString(&quot;,&quot;)</span>
<span class="nc" id="L96">        return &quot;{$valueString}&quot;</span>
    }

    object Serializer : KSerializer&lt;MutableMap&lt;StringType, SerializableType&gt;&gt; {
<span class="fc" id="L100">        private val delegate = MapSerializer(KeySerializer, SerializableType.serializer())</span>

        @OptIn(ExperimentalSerializationApi::class)
<span class="fc" id="L103">        override val descriptor = SerialDescriptor(&quot;TableType&quot;, delegate.descriptor)</span>

        override fun deserialize(decoder: Decoder): MutableMap&lt;StringType, SerializableType&gt; {
<span class="fc" id="L106">            return delegate.deserialize(decoder).toMutableMap()</span>
        }

        override fun serialize(encoder: Encoder, value: MutableMap&lt;StringType, SerializableType&gt;) {
<span class="fc" id="L110">            return delegate.serialize(encoder, value)</span>
        }
    }

    object KeySerializer : KSerializer&lt;StringType&gt; {
<span class="fc" id="L115">        override val descriptor: SerialDescriptor = PrimitiveSerialDescriptor(&quot;KeyValue&quot;, PrimitiveKind.STRING)</span>

        override fun deserialize(decoder: Decoder): StringType {
<span class="fc" id="L118">            return StringType(decoder.decodeString())</span>
        }

        override fun serialize(encoder: Encoder, value: StringType) {
<span class="fc" id="L122">            return encoder.encodeString(value.value)</span>
        }
    }
<span class="fc" id="L125">}</span>

<span class="nc" id="L127">infix fun String.to(that: String): Pair&lt;String, StringType&gt; = Pair(this, StringType(that))</span>
<span class="nc" id="L128">infix fun String.to(that: Number): Pair&lt;String, NumberType&gt; = Pair(this, NumberType(that.toDouble()))</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>