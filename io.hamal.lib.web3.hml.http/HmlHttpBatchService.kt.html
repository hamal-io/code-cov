<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HmlHttpBatchService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bootstrap</a> &gt; <a href="index.source.html" class="el_package">io.hamal.lib.web3.hml.http</a> &gt; <span class="el_source">HmlHttpBatchService.kt</span></div><h1>HmlHttpBatchService.kt</h1><pre class="source lang-java linenums">package io.hamal.lib.web3.hml.http

import io.hamal.lib.http.HttpTemplate
import io.hamal.lib.http.body
import io.hamal.lib.web3.eth.abi.type.EthUint64
import io.hamal.lib.web3.eth.domain.EthRequestId
import io.hamal.lib.web3.hml.HmlBatchService
import io.hamal.lib.web3.hml.domain.Chain
import io.hamal.lib.web3.hml.domain.HmlCallResponse
import io.hamal.lib.web3.hml.domain.HmlGetBlockResponse
import io.hamal.lib.web3.hml.domain.HmlResponse
import kotlinx.serialization.InternalSerializationApi
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.JsonArray
import kotlinx.serialization.json.JsonObject
import kotlinx.serialization.json.JsonPrimitive
import kotlinx.serialization.serializer
import java.util.concurrent.locks.ReentrantLock
import kotlin.concurrent.withLock
import kotlin.reflect.KClass

<span class="nc" id="L22">class HmlHttpBatchService(</span>
<span class="nc" id="L23">    private val httpTemplate: HttpTemplate,</span>
<span class="nc" id="L24">    override val chain: Chain = Chain.Eth</span>
) : HmlBatchService&lt;HmlHttpBatchService&gt; {

<span class="nc" id="L27">    private val lock = ReentrantLock()</span>
<span class="nc" id="L28">    private val resultClasses = mutableListOf&lt;KClass&lt;*&gt;&gt;()</span>
<span class="nc" id="L29">    private val requests = mutableListOf&lt;JsonObject&gt;()</span>

<span class="nc" id="L31">    override fun getBlock(number: EthUint64) = request(</span>
<span class="nc" id="L32">        method = &quot;${chain.name.lowercase()}_get_block_by_number&quot;,</span>
<span class="nc" id="L33">        params = JsonArray(</span>
<span class="nc" id="L34">            listOf(</span>
<span class="nc" id="L35">                JsonPrimitive(number.toPrefixedHexString().value),</span>
<span class="nc" id="L36">                JsonPrimitive(true)</span>
            )
        ),
        resultClass = HmlGetBlockResponse::class
<span class="nc" id="L40">    )</span>

<span class="nc" id="L42">    override fun call(callRequest: HmlBatchService.CallRequest) = request(</span>
<span class="nc" id="L43">        method = &quot;${chain.name.lowercase()}_call&quot;,</span>
<span class="nc" id="L44">        params = JsonArray(</span>
<span class="nc" id="L45">            listOf(</span>
<span class="nc" id="L46">                JsonObject(</span>
<span class="nc" id="L47">                    mapOf(</span>
<span class="nc" id="L48">                        &quot;to&quot; to JsonPrimitive(callRequest.to.toPrefixedHexString().value),</span>
<span class="nc" id="L49">                        &quot;data&quot; to JsonPrimitive(callRequest.data.value)</span>
                    )
                ),
<span class="nc" id="L52">                JsonPrimitive(callRequest.blockNumber.toPrefixedHexString().value),</span>
            )
        ),
        resultClass = HmlCallResponse::class
<span class="nc" id="L56">    )</span>

    override fun lastRequestId(): EthRequestId {
<span class="nc" id="L59">        return EthRequestId(requests.size)</span>
    }

    @OptIn(InternalSerializationApi::class)
    override fun execute(): List&lt;HmlResponse&gt; {
<span class="nc" id="L64">        return lock.withLock {</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (requests.isEmpty()) {</span>
<span class="nc" id="L67">                return listOf()</span>
            }

<span class="nc" id="L70">            val response = httpTemplate</span>
<span class="nc" id="L71">                .post(&quot;/hml&quot;)</span>
<span class="nc" id="L72">                .body(JsonArray(requests))</span>
<span class="nc" id="L73">                .execute(JsonArray::class)</span>

<span class="nc" id="L75">            response.zip(resultClasses)</span>
<span class="nc" id="L76">                .map { (response, resultClass) -&gt; json.decodeFromJsonElement(resultClass.serializer(), response) }</span>
<span class="nc" id="L77">                .filterIsInstance&lt;HmlResponse&gt;()</span>
<span class="nc" id="L78">                .also {</span>
<span class="nc" id="L79">                    requests.clear()</span>
<span class="nc" id="L80">                    resultClasses.clear()</span>
<span class="nc" id="L81">                }</span>
        }
    }

    private fun &lt;RESPONSE : HmlResponse&gt; request(
        method: String,
        params: JsonArray,
        resultClass: KClass&lt;RESPONSE&gt;
    ): HmlHttpBatchService {
<span class="nc" id="L90">        addRequest(</span>
            createReq = { id -&gt;
<span class="nc" id="L92">                JsonObject(</span>
<span class="nc" id="L93">                    mapOf(</span>
<span class="nc" id="L94">                        &quot;jsonrpc&quot; to JsonPrimitive(&quot;2.0&quot;),</span>
<span class="nc" id="L95">                        &quot;id&quot; to JsonPrimitive(id),</span>
<span class="nc" id="L96">                        &quot;method&quot; to JsonPrimitive(method),</span>
<span class="nc" id="L97">                        &quot;params&quot; to params,</span>
                    )
                )
            },
<span class="nc" id="L101">            resultClass = resultClass</span>
        )
<span class="nc" id="L103">        return this</span>
    }

    private fun &lt;RESPONSE : HmlResponse&gt; addRequest(createReq: (Int) -&gt; JsonObject, resultClass: KClass&lt;RESPONSE&gt;) {
<span class="nc" id="L107">        lock.withLock {</span>
<span class="nc" id="L108">            val reqId = requests.size + 1</span>
<span class="nc" id="L109">            resultClasses.add(resultClass)</span>
<span class="nc" id="L110">            requests.add(createReq(reqId))</span>
        }
<span class="nc" id="L112">    }</span>

<span class="nc" id="L114">    private val json = Json { ignoreUnknownKeys = true }</span>
<span class="nc" id="L115">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>